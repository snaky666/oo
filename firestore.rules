
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ================= HELPER FUNCTIONS =================
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isSeller() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'seller';
    }
    
    function isBuyer() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'buyer';
    }
    
    function isOwner(uid) {
      return request.auth.uid == uid;
    }
    
    // Validation functions
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    function isValidPrice(price) {
      return price >= 10000 && price <= 10000000 && price == int(price);
    }
    
    function isValidAge(age) {
      return age >= 6 && age <= 60 && age == int(age);
    }
    
    function isValidWeight(weight) {
      return weight >= 5 && weight <= 200 && weight == int(weight);
    }

    // ================= USERS COLLECTION =================
    match /users/{userId} {
      // Read: Anyone can read public profile info
      allow read: if true;
      
      // Create: Owner creates their own profile (registration)
      allow create: if isOwner(userId) && 
        isValidEmail(request.resource.data.email) &&
        request.resource.data.role in ['buyer', 'seller', 'admin'] &&
        request.resource.data.fullName.size() >= 2;
      
      // Update: Owner updates own profile OR admin manages users
      allow update: if isOwner(userId) || isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= SHEEP COLLECTION =================
    match /sheep/{sheepId} {
      // Read: Approved sheep visible to public, owner sees their own (pending/rejected), admin sees all
      allow read: if resource.data.status == 'approved' || 
                     (isAuthenticated() && isOwner(resource.data.sellerId)) ||
                     isAdmin();
      
      // Create: Seller creates listing OR Admin creates foreign sheep
      allow create: if (isSeller() && 
                       isOwner(request.resource.data.sellerId) &&
                       isValidPrice(request.resource.data.price) &&
                       isValidAge(request.resource.data.age) &&
                       isValidWeight(request.resource.data.weight) &&
                       request.resource.data.description.size() >= 20 &&
                       request.resource.data.images.size() >= 1 &&
                       request.resource.data.status == 'pending') ||
                       (isAdmin() &&
                       isValidPrice(request.resource.data.price) &&
                       isValidAge(request.resource.data.age) &&
                       isValidWeight(request.resource.data.weight) &&
                       request.resource.data.description.size() >= 10 &&
                       request.resource.data.images.size() >= 1);
      
      // Update: Seller updates pending listings, admin can update any
      allow update: if (isSeller() && isOwner(resource.data.sellerId) && resource.data.status == 'pending') ||
                       (isAdmin() && request.resource.data.status in ['approved', 'rejected', 'pending']);
      
      // Delete: Seller deletes own, admin deletes any
      allow delete: if (isSeller() && isOwner(resource.data.sellerId)) || isAdmin();
    }

    // ================= ORDERS COLLECTION =================
    match /orders/{orderId} {
      // Read: Buyer reads own, seller reads orders for their sheep, admin reads all, backend can read
      allow read: if isAdmin() || 
                     (isAuthenticated() && isOwner(resource.data.buyerId)) ||
                     (isAuthenticated() && isSeller() && resource.data.sellerId == request.auth.uid) ||
                     request.auth == null;
      
      // Create: Authenticated users or backend server can create orders
      allow create: if request.auth == null ||
                       (isAuthenticated() && 
                       request.auth.uid == request.resource.data.buyerId &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.totalPrice >= 1000 &&
                       request.resource.data.totalPrice <= 10000000 &&
                       request.resource.data.buyerName is string &&
                       request.resource.data.buyerName.size() >= 2 &&
                       request.resource.data.buyerPhone is string &&
                       request.resource.data.buyerPhone.size() >= 7 &&
                       request.resource.data.buyerCity is string &&
                       request.resource.data.buyerAddress is string &&
                       request.resource.data.paymentMethod in ['cash', 'card', 'installment'] &&
                       request.resource.data.paymentStatus in ['pending', 'completed', 'verified', 'rejected'] &&
                       request.resource.data.orderStatus in ['new', 'confirmed', 'ready', 'delivered', 'cancelled'] &&
                       // Allow foreign sheep optional fields
                       (!request.resource.data.keys().hasAny(['nationalId', 'paySlipImageUrl', 'workDocImageUrl']) ||
                        (request.resource.data.sheepOrigin == 'foreign' &&
                         request.resource.data.nationalId is string &&
                         request.resource.data.nationalId.size() >= 5 &&
                         request.resource.data.paySlipImageUrl is string &&
                         request.resource.data.paySlipImageUrl.matches('^https://.*') &&
                         request.resource.data.workDocImageUrl is string &&
                         request.resource.data.workDocImageUrl.matches('^https://.*'))));
      
      // Update: Buyer can update own pending orders, Admin can update any, backend can update
      allow update: if request.auth == null ||
                       (isAuthenticated() && isOwner(resource.data.buyerId) && resource.data.status == 'pending') ||
                       (isAdmin());
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= PAYMENTS COLLECTION =================
    match /payments/{paymentId} {
      // Read: User reads own, admin reads all
      allow read: if (isAuthenticated() && isOwner(resource.data.userId)) || isAdmin();
      
      // Create: Authenticated user creates for their order
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.userId) &&
                       isValidPrice(request.resource.data.amount) &&
                       request.resource.data.method in ['card', 'cash', 'installment'];
      
      // Update: Admin only (verification)
      allow update: if isAdmin() && request.resource.data.status in ['pending', 'completed', 'failed', 'cancelled'];
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= CIB RECEIPTS COLLECTION =================
    match /cibReceipts/{receiptId} {
      // Read: User reads own, admin reads all
      allow read: if (isAuthenticated() && isOwner(resource.data.userId)) || isAdmin();
      
      // Create: User uploads own receipt
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.userId) &&
                       request.resource.data.receiptImageUrl.matches('^https://.*');
      
      // Update: Admin only (verification)
      allow update: if isAdmin() && request.resource.data.status in ['pending', 'verified', 'rejected'];
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= INSTALLMENTS COLLECTION =================
    match /installments/{installmentId} {
      // Read: User reads own, admin reads all
      allow read: if (isAuthenticated() && isOwner(resource.data.userId)) || isAdmin();
      
      // Create: Backend creates (validated by admin)
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      
      // Update: Admin only
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= VIP SUBSCRIPTIONS COLLECTION =================
    match /vipSubscriptions/{subscriptionId} {
      // Read: User reads own, admin reads all
      allow read: if (isAuthenticated() && isOwner(resource.data.userId)) || isAdmin();
      
      // Create: User creates own subscription
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.userId) &&
                       request.resource.data.package in ['silver', 'gold', 'platinum'] &&
                       isValidPrice(request.resource.data.price);
      
      // Update: User can toggle auto-renew, admin can update any
      allow update: if (isAuthenticated() && isOwner(resource.data.userId)) || isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= ADVERTISEMENTS COLLECTION =================
    match /ads/{adId} {
      // Read: Public can read active ads, admin can read all, backend can read
      allow read: if resource.data.active == true || isAdmin() || request.auth == null;
      
      // Create: Admin or backend server
      allow create: if isAdmin() || request.auth == null;
      
      // Update: Admin or backend server
      allow update: if isAdmin() || request.auth == null;
      
      // Delete: Admin or backend server
      allow delete: if isAdmin() || request.auth == null;
    }

    // ================= REVIEWS COLLECTION =================
    match /reviews/{reviewId} {
      // Read: Public can read all reviews
      allow read: if true;
      
      // Create: Buyer creates review for purchased sheep
      allow create: if isBuyer() && 
                       isOwner(request.resource.data.buyerId) &&
                       request.resource.data.rating >= 1 && 
                       request.resource.data.rating <= 5;
      
      // Update: Owner updates own review
      allow update: if isAuthenticated() && isOwner(resource.data.buyerId);
      
      // Delete: Owner or admin
      allow delete: if (isAuthenticated() && isOwner(resource.data.buyerId)) || isAdmin();
    }

    // ================= FAVORITES COLLECTION =================
    match /favorites/{favoriteId} {
      // Read: User reads own favorites
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Create: User adds to favorites
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      
      // Delete: User removes from favorites
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // ================= NOTIFICATIONS COLLECTION =================
    match /notifications/{notificationId} {
      // Read: User reads own notifications
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Create: Backend or admin creates notifications
      allow create: if isAdmin() || request.auth == null;
      
      // Update: User marks as read, admin can update
      allow update: if (isAuthenticated() && isOwner(resource.data.userId)) || isAdmin();
      
      // Delete: Owner or admin
      allow delete: if (isAuthenticated() && isOwner(resource.data.userId)) || isAdmin();
    }

    // ================= SUPPORT TICKETS COLLECTION =================
    match /support/{ticketId} {
      // Read: User reads own tickets, admin reads all
      allow read: if (isAuthenticated() && isOwner(resource.data.userId)) || isAdmin();
      
      // Create: Authenticated user creates ticket
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      
      // Update: Admin responds to tickets
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= PASSWORD RESET TOKENS COLLECTION =================
    match /passwordResetTokens/{tokenId} {
      // Read: Backend only (no client access)
      allow read: if request.auth == null;
      
      // Create: Backend creates tokens
      allow create: if request.auth == null;
      
      // Update: Backend updates tokens
      allow update: if request.auth == null;
      
      // Delete: Backend deletes used tokens
      allow delete: if request.auth == null;
    }

    // ================= EMAIL VERIFICATION TOKENS COLLECTION =================
    match /emailVerificationTokens/{tokenId} {
      // Read: Backend only (no client access)
      allow read: if request.auth == null;
      
      // Create: Backend creates tokens
      allow create: if request.auth == null;
      
      // Update: Backend updates tokens
      allow update: if request.auth == null;
      
      // Delete: Backend deletes used tokens
      allow delete: if request.auth == null;
    }

    // ================= DEFAULT DENY =================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
