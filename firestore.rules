
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Pending registrations collection (server-side only)
    match /pending_registrations/{docId} {
      allow read, write: if false; // Only server can access
    }

    // ================= HELPER FUNCTIONS =================
    function isAuth() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isSeller() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'seller';
    }

    function isBuyer() {
      return isAuth() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'buyer' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'seller');
    }

    function owns(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    function isApproved() {
      return resource.data.status == 'approved';
    }

    // ================= USERS COLLECTION =================
    match /users/{userId} {
      // Read: Public basic info OR owner OR admin OR anyone for email verification
      allow read: if true;
      
      // Create: Self registration only OR server-side creation
      allow create: if true;
      
      // Update: Owner or admin (admin can manage VIP) OR server for email verification
      allow update: if true;
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= SHEEP COLLECTION =================
    match /sheep/{sheepId} {
      // Read: Approved sheep visible to all, sellers see their own, admin sees all
      allow read: if isApproved() || isAdmin() || (isAuth() && resource.data.sellerId == request.auth.uid);
      
      // Create: Sellers only with their own ID
      allow create: if isSeller() && request.resource.data.sellerId == request.auth.uid;
      
      // Update: Sellers update their own (status set by admin), admins update any
      allow update: if isAdmin() || (isSeller() && resource.data.sellerId == request.auth.uid);
      
      // Delete: Sellers delete their own, admins delete any
      allow delete: if isAdmin() || (isSeller() && resource.data.sellerId == request.auth.uid);
    }

    // ================= ORDERS COLLECTION =================
    match /orders/{orderId} {
      // Read: Buyer reads own, seller reads for their sheep, admin reads all
      allow read: if isAdmin() || owns(resource.data.buyerId) || 
                     (isSeller() && get(/databases/$(database)/documents/sheep/$(resource.data.sheepId)).data.sellerId == request.auth.uid);
      
      // Create: Buyers create orders
      allow create: if isBuyer() && request.resource.data.buyerId == request.auth.uid;
      
      // Update: Admin updates orders
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= PAYMENTS COLLECTION =================
    match /payments/{paymentId} {
      // Read: User reads own, admin reads all
      allow read: if owns(resource.data.userId) || isAdmin();
      
      // Create: Authenticated user creates own payment
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      
      // Update: Admin only
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= CIB RECEIPTS COLLECTION =================
    match /cibReceipts/{receiptId} {
      // Read: User reads own, admin reads all
      allow read: if owns(resource.data.userId) || isAdmin();
      
      // Create: User uploads own receipt
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      
      // Update: Admin only (verification/rejection)
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= INSTALLMENTS COLLECTION =================
    match /installments/{installmentId} {
      // Read: User reads own, admin reads all
      allow read: if owns(resource.data.userId) || isAdmin();
      
      // Create: Authenticated users can create (backend handles)
      allow create: if isAuth();
      
      // Update: Admin only
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= VIP SUBSCRIPTIONS COLLECTION =================
    match /vipSubscriptions/{subId} {
      // Read: User reads own, admin reads all
      allow read: if owns(resource.data.userId) || isAdmin();
      
      // Create: Authenticated users can create
      allow create: if isAuth();
      
      // Update: Admin only
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= REVIEWS COLLECTION =================
    match /reviews/{reviewId} {
      // Read: Anyone can read reviews
      allow read: if true;
      
      // Create: Buyers create reviews
      allow create: if isBuyer() && request.resource.data.buyerId == request.auth.uid;
      
      // Update: Reviewer updates own review
      allow update: if owns(resource.data.reviewerId);
      
      // Delete: Reviewer deletes own or admin deletes
      allow delete: if owns(resource.data.reviewerId) || isAdmin();
    }

    // ================= FAVORITES COLLECTION =================
    match /favorites/{userId}/{sheepId=**} {
      // Read: User reads own or admin reads
      allow read: if owns(userId) || isAdmin();
      
      // Write: User manages own
      allow write, delete: if owns(userId);
    }

    // ================= NOTIFICATIONS COLLECTION =================
    match /notifications/{userId}/{notificationId=**} {
      // Read: User reads own
      allow read: if owns(userId);
      
      // Create: System or user
      allow create: if owns(userId) || request.auth.token.firebase.sign_in_provider == 'custom';
      
      // Delete: User deletes own
      allow delete: if owns(userId);
    }

    // ================= SUPPORT COLLECTION =================
    match /support/{ticketId} {
      // Read: User reads own or admin reads all
      allow read: if owns(resource.data.userId) || isAdmin();
      
      // Create: User creates own ticket
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      
      // Update: User updates own or admin updates
      allow update: if owns(resource.data.userId) || isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ================= ADMIN LOGS COLLECTION =================
    match /adminLogs/{logId} {
      // Admin only
      allow read, write, delete: if isAdmin();
    }

    // ================= DEFAULT DENY =================
    match /{document=**} {
      allow read, write, delete: if false;
    }
  }
}
